# Image2Shape - Technical Architecture Documentation

## System Overview

Image2Shape is a Python application for automated feature detection in drone imagery using machine learning and photogrammetric georeferencing. The system processes drone images to detect and classify features, then exports results as georeferenced shapefiles for GIS analysis.

**Core Technologies**: Tkinter GUI, OpenCV image processing, scikit-learn ML algorithms, photogrammetric georeferencing, ESRI Shapefile export
**Architecture**: Multi-algorithm ML framework with factory pattern
**Coordinate System**: WGS84 with photogrammetric transformation

## Processing Workflow

1. **Image Loading**: Multi-folder support with metadata extraction and display image caching
2. **Metadata Processing**: GPS/RTK data extraction using exiftool with validation
3. **Manual Annotation**: Rectangle-based annotation system for training data creation
4. **ML Training**: Multi-algorithm training (Random Forest, KNN) on RGB+HSV pixel features
5. **Feature Detection**: Grid-based pixel classification with confidence scoring and filtering
6. **Georeferencing**: Photogrammetric coordinate transformation to WGS84
7. **Export**: Shapefile generation with multiple export types and optional PDF reports

## Technical Architecture

### Core Components

#### 1. GUI Framework (Tkinter)
- **Main Window**: Three-panel interface with image list, metadata summary, and image viewer
- **Image Viewer**: Canvas with zoom/pan and annotation tools
- **Annotation Tools**: Rectangle drawing (left-click=background/cyan, right-click=feature/red)
- **Navigation**: Arrow key support for image switching
- **ML Algorithm Dialog**: Algorithm selection and parameter configuration
- **Export Dialog**: Export type selection and configuration
- **Progress Dialogs**: Training and export progress tracking

#### 2. Processing Components
```python
class MetadataProcessor:
    - extract_metadata()        # GPS/RTK data extraction using exiftool
    - validate_metadata()       # GPS/RTK/altitude validation
    
class AnnotationManager:
    - create_annotation()       # Store rectangle coordinates and class
    - auto_save_annotations()   # JSON format persistence
    - load_annotations()        # Session restoration
    - get_annotation_count()    # Training data statistics
```

#### 3. Machine Learning Framework
```python
class MLAlgorithmFactory:
    - get_available_algorithms()    # Available algorithm types
    - create_algorithm()            # Algorithm instantiation
    - get_algorithm_info()          # Algorithm capabilities and parameters

class RandomForestAlgorithm(MLAlgorithmBase):
    - train(), predict(), predict_proba()  # Core ML operations
    - save_model(), load_model()           # Model persistence
    - get_training_info()                  # Training statistics

class KNNAlgorithm(MLAlgorithmBase):
    - train(), predict(), predict_proba()  # Instance-based learning
    - save_model(), load_model()           # Model persistence

class FeatureExtractor:
    - extract_pixel_features_from_annotations()  # Training data preparation
    - extract_pixel_features_from_image_grid()   # Prediction sampling
    - get_feature_names()                        # RGB+HSV feature names

class ParallelFeatureExtractor:
    - prepare_training_data_parallel()    # Multi-threaded feature extraction
```

#### 4. Georeferencing System
```python
class SelfContainedGeoreferencer:
    - pixel_to_world_coordinates()       # Core coordinate transformation
    - apply_yaw_rotation()               # Drone heading correction
    - extract_complete_metadata()        # GPS/RTK metadata extraction

class BatchGeoreferencer:
    - precompute_image_parameters()      # Batch parameter computation
    - transform_coordinates_vectorized() # Vectorized coordinate transformation

class FootprintCalculator:
    - calculate_image_footprint()        # Image boundary calculation
    - get_drone_positions_from_images()  # Drone position extraction
```

#### 5. Export System
```python
class ShapefileExporter:
    - export_feature_points()           # Point feature export
    - export_feature_polygons()         # Buffered polygon export
    - export_combined_data()            # Multi-layer export

class OptimizedPolygonProcessor:
    - create_buffered_polygons()        # High-performance polygon processing
    - _preprocess_coordinates()         # Spatial optimization
    - _create_polygons_parallel()       # Multi-core processing

class CompactPDFGenerator:
    - generate_report()                 # PDF report generation
```

### Data Flow Architecture

```
[Multi-Folder Loading] → [Preprocessing Dialog] → [Metadata Cache] → [Combined Display]
                                              ↓
[Manual Annotation] → [Pixel Feature Extraction] → [ML Training (30k+ samples)]
                                              ↓
[Real-time Prediction] → [Confidence Filtering] → [Spatial Clustering] → [Display]
                                              ↓
[Batch Processing] → [Georeferencing] → [Coordinate Transformation] → [Shapefile Export]
                                              ↓
[QGIS Import] → [Spatial Analysis] → [Accuracy Validation] → [Error Investigation]
```

### File Structure

```
image2shape/
├── .agent.md                    # This architecture document
├── main.py                      # Application entry point
├── src/
│   ├── gui/
│   │   ├── main_window.py      # Main application interface
│   │   ├── image_viewer.py     # Image display and annotation tools
│   │   ├── map_widget.py       # GPS location visualization
│   │   ├── preprocessing_dialog.py # Folder loading with progress
│   │   ├── ml_algorithm_dialog.py # Algorithm selection dialog
│   │   └── export_dialog.py    # Export configuration dialog
│   ├── ml/
│   │   ├── algorithm_factory.py # ML algorithm factory pattern
│   │   ├── base_algorithm.py   # Base algorithm interface
│   │   ├── random_forest_algorithm.py # Random Forest implementation
│   │   ├── knn_algorithm.py    # K-Nearest Neighbors implementation
│   │   ├── feature_extractor.py # Pixel-based feature extraction
│   │   ├── parallel_feature_extractor.py # Multi-threaded extraction
│   │   └── random_forest_classifier.py # Legacy classifier
│   ├── processing/
│   │   ├── annotation_manager.py # Annotation save/load (JSON)
│   │   ├── metadata_processor.py # GPS metadata extraction
│   │   ├── batch_processor.py   # Batch ML processing framework
│   │   ├── parallel_batch_processor.py # Parallel batch processing
│   │   └── cache_manager.py     # Image and metadata caching
│   ├── georef/
│   │   ├── self_contained_georeferencer.py # Core georeferencing
│   │   ├── batch_georeferencer.py # Batch coordinate transformation
│   │   └── footprint_calculator.py # Image footprint calculation
│   └── export/
│       ├── shapefile_exporter.py # ESRI Shapefile export
│       ├── optimized_polygon_processor.py # High-performance polygons
│       ├── polygon_processor.py # Standard polygon processing
│       └── compact_pdf_generator.py # PDF report generation
├── data/
│   ├── annotations/            # Auto-saved annotation files (JSON)
│   └── models/                 # Trained ML models (joblib)
└── doc/
    ├── README.md               # Main documentation
    ├── USER_GUIDE.md           # Step-by-step user instructions
    └── requirements.txt        # Python dependencies
```

## Technical Implementation

### Machine Learning Implementation
- **Algorithms**: Random Forest and K-Nearest Neighbors via factory pattern
- **Features**: 6-dimensional pixel vectors [R,G,B,H,S,V]
- **Training Data**: Individual pixels extracted from annotation rectangles
- **Sample Size**: Typically 30,000+ pixels per training session
- **Training Time**: <30 seconds for typical datasets
- **Prediction**: Grid-based sampling with 5,000-10,000 pixels per image
- **Performance**: 1-2 seconds prediction time per 44MP image

### Image Processing
- **Input**: Drone images with GPS EXIF metadata (JPG/PNG/TIFF)
- **Display**: Cached downscaled images for GUI performance
- **Annotation**: Rectangle drawing with coordinate conversion
- **Prediction**: Grid-based pixel sampling with real-time filtering

### Georeferencing Implementation
- **Input**: Pixel coordinates, GPS position, flight altitude, drone yaw angle, focal length
- **Sensor Model**: DJI P1 specifications (4.4μm pixel size)
- **GSD Calculation**: (pixel_size × altitude) / (focal_length × 1000)
- **Coordinate System**: WGS84 (EPSG:4326)
- **Corrections**: Yaw rotation, longitude compression (cos(latitude) scaling)
- **Accuracy**: 10-30cm N-S, sub-meter E-W with longitude correction
- **Processing**: Vectorized operations for batch coordinate transformation

### Export Pipeline
- **Format**: ESRI Shapefile (.shp/.dbf/.shx)
- **Coordinates**: WGS84 (EPSG:4326)
- **Attributes**: Confidence scores, image sources, RTK status
- **Integration**: Direct QGIS import compatibility

### Dependencies and Requirements
```python
# Core Processing
opencv-python>=4.8.0    # Image processing and computer vision
scikit-learn>=1.3.0     # Machine learning algorithms
numpy>=1.24.0           # Numerical operations and vectorization
pillow>=10.0.0          # Image I/O and format support
matplotlib>=3.7.0       # Plotting and visualization

# GUI Framework  
tkinter                 # Built-in Python GUI (no separate install)

# Geospatial Processing
geopandas>=0.13.0       # Shapefile creation and geospatial operations
shapely>=2.0.0          # Geometric operations and polygon processing
fiona>=1.9.0            # Geospatial file I/O
rtree>=1.0.0            # Spatial indexing for polygon optimization

# Additional Components
psutil>=5.8.0           # System monitoring
reportlab>=4.0.0        # PDF report generation
folium>=0.14.0          # Interactive maps
pandas>=1.5.0           # Data manipulation

# Metadata Extraction
exiftool                # External dependency for EXIF/GPS metadata extraction

# System Requirements
# Python 3.8+, 4GB RAM minimum, 8GB recommended
# Linux (primary), Windows (supported), macOS (untested)
```

### System Requirements
- **RAM**: 4GB minimum, 8GB recommended
- **Storage**: SSD recommended for large datasets
- **OS**: Linux (primary), Windows (supported)
- **Python**: 3.8+ with conda environment

## Current Implementation Status

### Implemented Features
- **GUI Framework**: Tkinter interface with three-panel layout
- **Image Loading**: Multi-folder support with metadata caching and progress tracking
- **Annotation System**: Rectangle drawing with JSON persistence
- **Machine Learning**: Multi-algorithm framework (Random Forest, KNN) with pixel-based training
- **Real-time Filtering**: Confidence and clustering controls
- **Model Persistence**: Save/load of trained models
- **Navigation**: Image switching with arrow keys and cached display images
- **Batch Processing**: ML processing and shapefile export pipeline
- **Georeferencing**: Coordinate transformation with longitude compression correction
- **Shapefile Export**: Point, polygon, and combined export types with PDF reports
- **Map Integration**: GPS visualization with clickable navigation

### Performance Optimizations
- **Polygon Processing**: Optimized processing for large datasets (>5k points)
  - Spatial preprocessing and parallel buffering
  - R-tree spatial indexing for efficient merging
  - Automatic processor selection based on dataset size

### Performance Characteristics
- **Image Loading**: Parallel metadata extraction with ThreadPoolExecutor
- **Display Images**: Cached downscaled images for GUI responsiveness
- **ML Training**: Typically under 30 seconds for standard datasets
- **Prediction**: 1-2 seconds per image depending on size and sampling density
- **Batch Processing**: Parallel processing with configurable worker threads
- **Georeferencing**: Vectorized coordinate transformation
- **Memory Usage**: Moderate memory requirements for typical operations
- **Cache System**: Metadata and display image caching
- **Polygon Export**: Optimized processing with automatic algorithm selection

### Accuracy Characteristics
- **Positioning**: Sub-meter accuracy with longitude compression correction
- **ML Classification**: Performance depends on training data quality and filtering settings
- **Feature Detection**: Pixel-level annotation accuracy
- **GPS Integration**: Metadata extraction and validation from EXIF data

## Development Notes

### Code Organization
- **GUI**: Tkinter-based three-panel interface with modular components
- **Processing**: Modular pipeline with clear separation of concerns  
- **ML**: Multi-algorithm framework with factory pattern
- **Georeferencing**: Photogrammetric coordinate transformation implementation
- **Export**: Shapefile generation with multiple export types

### Key Design Decisions
- **Multi-algorithm ML**: Factory pattern for algorithm selection and extensibility
- **Multi-folder support**: Additive dataset management for complex projects
- **Real-time filtering**: Interactive confidence and clustering controls
- **Modular architecture**: Clear separation between GUI, processing, and export components